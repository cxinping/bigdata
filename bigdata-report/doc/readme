预测
https://pypi.org/project/pyramid-arima/

计算距离需要安装模块
Geopy

调用高德API查找地区的经纬度
https://lbs.amap.com/api/webservice/guide/tools/flowlevel

高德控制台
https://console.amap.com/dev/flow/manage/0e540c9f3f92b59a54529966d3e13e27

高德 key
d812403e36c2f01eb70d10b8b50e7e96

/root/anaconda3/bin/python -u /you_filed_algos/app/report/works/exec_02_data3.py

查询经纬度
https://jingweidu.bmcx.com/

常用表
select * from 01_datamart_layer_007_h_cw_df.finance_standard

select * from 01_datamart_layer_007_h_cw_df.finance_scenery

select * from 01_datamart_layer_007_h_cw_df.finance_person

select * from 01_datamart_layer_007_h_cw_df.finance_unusual


检查点
select unusual_id,unusual_shell,isalgorithm from 01_datamart_layer_007_h_cw_df.finance_unusual

黑名单
insert  into 01_datamart_layer_007_h_cw_df.finance_blacklist values (uuid(),'','文具','办公费');
insert  into 01_datamart_layer_007_h_cw_df.finance_blacklist values (uuid(),'','插座','办公费');

select * from 01_datamart_layer_007_h_cw_df.finance_blacklist where classify = '办公费';






############################### checkpoint 16    ###############################

select distinct commodityname from 01_datamart_layer_007_h_cw_df.finance_travel_bill
where commodityname is not null








############################### checkpoint 13     ###############################

select  * from   01_datamart_layer_007_h_cw_df.finance_rma_travel_accomm where exp_type_name="差旅费"

select  count(bill_id) from   01_datamart_layer_007_h_cw_df.finance_rma_travel_accomm where exp_type_name="差旅费"

select  * from  01_datamart_layer_007_h_cw_df.finance_rma_travel_members

select  * from 01_datamart_layer_007_h_cw_df.finance_hotel_standard

describe 01_datamart_layer_007_h_cw_df.finance_category_sign

差旅费明细表
select  * from   01_datamart_layer_007_h_cw_df.finance_rma_travel_accomm

人员信息表
select  * from  01_datamart_layer_007_h_cw_df.finance_rma_travel_members

住宿标准
select  * from 01_datamart_layer_007_h_cw_df.finance_hotel_standard

宽表 差旅费
select  * from 01_datamart_layer_007_h_cw_df.finance_travel_bill

select bill_id, city_name, city_grade_name, emp_name, hotel_amount/hotel_num from 01_datamart_layer_007_h_cw_df.finance_rma_travel_accomm
where exp_type_name='差旅费' and hotel_num > 0


01_datamart_layer_007_h_cw_df.finance_rma_travel_accomm   住宿
01_datamart_layer_007_h_cw_df.finance_rma_travel_journey  行程
01_datamart_layer_007_h_cw_df.finance_rma_travel_members  人员
01_datamart_layer_007_h_cw_df.finance_hotel_standard      住宿标准

宽表 差旅费
01_datamart_layer_007_h_cw_df.finance_travel_bill

select a.bill_id, a.city_name, a.city_grade_name, a.emp_name, a.hotel_amount/a.hotel_num, b.member_level_name from 01_datamart_layer_007_h_cw_df.finance_rma_travel_accomm a, 01_datamart_layer_007_h_cw_df.finance_travel_bill b
where a.exp_type_name="差旅费" and a.hotel_num > 0 and a.bill_id =b.bill_id




select distinct
a.bill_id, a.city_name, a.city_grade_name, a.emp_name,
a.hotel_amount/a.hotel_num as hotel_amount_day,
b.member_level_name,
b.account_period_y
from 01_datamart_layer_007_h_cw_df.finance_rma_travel_accomm a,
(
select distinct
bill_id,member_level_name, substr(cast(account_period as string),1,4) as account_period_y
from 01_datamart_layer_007_h_cw_df.finance_travel_bill
where substr(cast(account_period as string),1,4)='2021' )  b
where a.exp_type_name="差旅费" and a.hotel_num > 0 and
      a.bill_id =b.bill_id

---------------------------------

select distinct
a.bill_id, a.city_name, a.city_grade_name, a.emp_name,
a.hotel_amount/a.hotel_num as hotel_amount_day,
b.member_level_id, b.member_level_name,
b.account_period_y
from 01_datamart_layer_007_h_cw_df.finance_rma_travel_accomm a,
(
select distinct
bill_id,member_level_id,member_level_name, substr(cast(account_period as string),1,4) as account_period_y
from 01_datamart_layer_007_h_cw_df.finance_travel_bill
where substr(cast(account_period as string),1,4)='2021' and member_level_id is not null )  b
where a.exp_type_name="差旅费" and a.hotel_num > 0 and
      a.bill_id =b.bill_id

查询2021年的员工住宿费用的记录总数
select count(*) from (
select distinct
a.bill_id, a.city_name, a.city_grade_name, a.emp_name,
a.hotel_amount/a.hotel_num as hotel_amount_day,
b.member_level_id, b.member_level_name,
b.account_period_y
from 01_datamart_layer_007_h_cw_df.finance_rma_travel_accomm a,
(
select distinct
bill_id,member_level_id,member_level_name, substr(cast(account_period as string),1,4) as account_period_y
from 01_datamart_layer_007_h_cw_df.finance_travel_bill
where substr(cast(account_period as string),1,4)='2021' )  b
where a.exp_type_name="差旅费" and a.hotel_num > 0 and
      a.bill_id =b.bill_id
      ) zzz




SELECT DISTINCT
a.bill_id, a.city_name, a.city_grade_name, a.emp_name,ROUND(a.stand_amount, 2) as stand_amount_perday,
ROUND(a.hotel_amount/a.hotel_num , 2) as hotel_amount_perday
FROM 01_datamart_layer_007_h_cw_df.finance_rma_travel_accomm a
WHERE a.exp_type_name="差旅费" AND a.hotel_num > 0
AND ROUND(a.hotel_amount/a.hotel_num , 2)  > ROUND(a.stand_amount, 2)

查询超过标准报销费用的住宿费记录
SELECT a.bill_id, a.city_name, a.city_grade_name, a.emp_name,a.stand_amount_perday, a.hotel_amount_perday
FROM (
SELECT DISTINCT
bill_id, city_name, city_grade_name, emp_name,ROUND(stand_amount, 2) as stand_amount_perday,
ROUND(hotel_amount/hotel_num , 2) as hotel_amount_perday
FROM 01_datamart_layer_007_h_cw_df.finance_rma_travel_accomm
WHERE exp_type_name="差旅费" AND hotel_num > 0
)as a
WHERE a.hotel_amount_perday  > a.stand_amount_perday

查询地区
SELECT  a.city_name, a.city_grade_name
FROM (
SELECT DISTINCT
 city_name, city_grade_name
 FROM 01_datamart_layer_007_h_cw_df.finance_rma_travel_accomm
WHERE exp_type_name="差旅费" AND hotel_num > 0
)as a
ORDER BY a.city_grade_name ASC

############################### checkpoint 14     ###############################

SELECT bill_id, origin_name, destin_name, jour_amount FROM 01_datamart_layer_007_h_cw_df.finance_travel_bill
WHERE jour_amount > 0

############################### checkpoint 2     ###############################

select area_id, area_name, parent_id, grade from 01_datamart_layer_007_h_cw_df.finance_province_city where area_name like '%房山%'



select origin_province from 01_datamart_layer_007_h_cw_df.finance_travel_bill
where origin_province not like '%银行%'
--and origin_province  like '%区%'
and origin_province not like '%自治区%'
and origin_province not  rlike '[A-Z]*[0-9]+'
and origin_province != 'null'
group by origin_province


select destin_province from 01_datamart_layer_007_h_cw_df.finance_travel_bill
where destin_province not like '%银行%'
--and destin_province  like '%区%'
and destin_province not like '%自治区%'
and destin_province not  rlike '[A-Z]*[0-9]+'
and destin_province != 'null'
group by destin_province


select * from  02_logical_layer_007_h_lf_cw.finance_travel_linshi_analysis where  origin_province  like '%区%'

truncate table 02_logical_layer_007_h_lf_cw.finance_travel_linshi_analysis

select * from  02_logical_layer_007_h_lf_cw.finance_travel_linshi_analysis

refresh  02_logical_layer_007_h_lf_cw.finance_travel_linshi_analysis


upsert into table  01_datamart_layer_007_h_cw_df.finance_travel_bill (finance_travel_id,sales_address,origin_province,destin_province)
select
    finance_travel_id,
    sales_address,
  origin_province,
  destin_province
from
    02_logical_layer_007_h_lf_cw.finance_travel_linshi_analysis

truncate table 02_logical_layer_007_h_lf_cw.finance_travel_linshi_analysis

refresh  02_logical_layer_007_h_lf_cw.finance_travel_linshi_analysis

load data inpath '/user/hive/warehouse/03_basal_layer_zfybxers00.db/zfybxers00_z_rma_cost_detail_m/importdate=20210923' into table 03_basal_layer_zfybxers00.zfybxers00_z_rma_cost_detail_m  partition (importdate="20210923")



############################### checkpoint 14     ###############################

SELECT a.bill_id, a.city_name, a.city_grade_name, a.emp_name,a.stand_amount_perday, a.hotel_amount_perday
    FROM (
    SELECT DISTINCT
    bill_id, city_name, city_grade_name, emp_name,ROUND(stand_amount, 2) as stand_amount_perday,
    ROUND(hotel_amount/hotel_num , 2) as hotel_amount_perday
    FROM 01_datamart_layer_007_h_cw_df.finance_rma_travel_accomm
    WHERE exp_type_name="差旅费" AND hotel_num > 0
    )as a
WHERE a.hotel_amount_perday < a.stand_amount_perday















